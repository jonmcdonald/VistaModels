<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
    <meta name="GENERATOR" content="Quadralay WebWorks AutoMap 2003 for FrameMaker 8.0.2.1385" />
    <meta name="TEMPLATEBASE" content="mgc_ww_v2.1.078" />
    <meta name="LASTUPDATED" content="Tue Nov 27 10:02:48 2012" />
    <meta name="mgc_html_doctitle" content="Vista User's Manual" />
    <title>Trace API Example </title>
<!-- Search Engine keywords -->
    <meta name="attributes" content=" doc.type.documentation.user,doc.type.documentation.ref,product.version.v3.5,product.name.vista"/>
<!-- JavaScript Files -->
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/context.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/js/file_list.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/js/breadcrumbs.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/js/docvars.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/towwhdir.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/wwhpagef.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhdata/common/topics.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="wwhelp/wwhimpl/common/scripts/popup_window.js"></script>
    <script type="text/javascript" language="JavaScript1.2" src="scripts/expand.js"></script>
    <script type="text/javascript" language="JavaScript1.2">
    <!--
      // Set reference to top level help frame
      //
      if (( window.name != "SearchTopic") && ( window.name != "PopupTopic"))
      {   var  WWHFrame = WWHGetWWHFrame(  ""); }
      else
      { var WWHFrame = eval("parent.parent"); }
      // -->
    </script>
    <script type="text/javascript" language="JavaScript1.2">
    <!--
    var  WWHFrame = eval("parent.parent");
	document.write(MGCGetInternalStyleSheet(1));
	document.write(MGCGetDocumentStyleSheet(0));
	document.write(MGCGetPGFStyleSheet(0));
    // -->
    </script>
  </head>


<body class="body" rightmargin="25" onLoad="WWHUpdate();" onUnload="WWHUnload();" onKeyDown="WWHHandleKeyDown((document.all||document.getElementById||document.layers)?event:null);" onKeyPress="WWHHandleKeyPress((document.all||document.getElementById||document.layers)?event:null);" onKeyUp="WWHHandleKeyUp((document.all||document.getElementById||document.layers)?event:null);">





 <script type="text/javascript" language="JavaScript1.2">
    <!--
      MGCInsertRTHeader(210);
    // -->
 </script>
 

<!--154,210,0-->
<!--EnDhEaDeR-->

<a name="MGCCIDPTrace API Example "></a>

<a name="wp28268"></a><h3 class="pHeading2">
  


Trace API Example 
  </h3>



<a name="wp28269"></a><p class="pBody">
The following example shows how to use the trace API (both core and cache trace APIs), this example uses the hardware control mode in which the cache configuration is controlled by hardware parameters/model code, the hardware control is the default mode. (In software control mode, simulated software controls the cache behavior).
</p>





<a name="wp28271"></a><p class="pFigureTitle">
Figure 8&#8209;16. 


Trace API Example System


</p>
<div align="center"><img src="images/TraceAPIExampleSystem.gif" id="wp31028" border="0" hspace="0" vspace="0"/></div><p class="pFigureTitle">





</p>



<a name="wp28273"></a><p class="pBody">
The example uses the basic ARM926 tutorial which can be found under Vista installation directory, the example has been expanded to demonstrate the use of the trace API capability. The changes were added to the main.cpp file:
</p>


<a name="wp28274"></a><pre class="pCode">     #include &quot;mb/models/cache.h&quot;</pre>


<a name="wp28276"></a><pre class="pCode">     //Define the cache trace class and overload the required callbacks</pre>


<a name="wp28277"></a><pre class="pCode">     class my_cache_trace : public mb::models::cache_b::trace </pre>


<a name="wp28278"></a><pre class="pCode">     {</pre>


<a name="wp28279"></a><pre class="pCode">      private:</pre>


<a name="wp28280"></a><pre class="pCode">       const char*  instance_name;</pre>


<a name="wp28281"></a><pre class="pCode">      public:</pre>


<a name="wp28282"></a><pre class="pCode">       my_cache_trace() {};</pre>


<a name="wp28283"></a><pre class="pCode">       my_cache_trace(const char* name) : instance_name(name) {};</pre>


<a name="wp28284"></a><pre class="pCode">       </pre>


<a name="wp28285"></a><pre class="pCode">       //===============================================================</pre>


<a name="wp28286"></a><pre class="pCode">       // Cache Write Hit Callback  </pre>


<a name="wp28287"></a><pre class="pCode">       //===============================================================</pre>


<a name="wp28288"></a><pre class="pCode">       virtual void write_hit(uint64_t address, unsigned line)</pre>


<a name="wp28289"></a><pre class="pCode">       {</pre>


<a name="wp28290"></a><pre class="pCode">         std::cout &lt;&lt; sc_core::sc_time_stamp() &lt;&lt; &quot;: &quot; &lt;&lt; instance_name  </pre>


<a name="wp28291"></a><pre class="pCode">                   &lt;&lt; &quot; write_hit line= &quot; &lt;&lt; line </pre>


<a name="wp28292"></a><pre class="pCode">                   &lt;&lt; &quot; address= 0x&quot; &lt;&lt; hex &lt;&lt; address &lt;&lt; endl;</pre>


<a name="wp28293"></a><pre class="pCode">       }</pre>


<a name="wp28294"></a><pre class="pCode">       </pre>


<a name="wp28295"></a><pre class="pCode">       virtual void write_miss(uint64_t address)</pre>


<a name="wp28296"></a><pre class="pCode">       {</pre>


<a name="wp28297"></a><pre class="pCode">         std::cout &lt;&lt; sc_core::sc_time_stamp() &lt;&lt; &quot;: &quot; &lt;&lt; instance_name  </pre>


<a name="wp28298"></a><pre class="pCode">                   &lt;&lt; &quot; write miss callback was called : &quot;</pre>


<a name="wp28299"></a><pre class="pCode">                   &lt;&lt; &quot; address= 0x&quot; &lt;&lt; hex &lt;&lt; address &lt;&lt; endl;</pre>


<a name="wp28300"></a><pre class="pCode">       }</pre>


<a name="wp28301"></a><pre class="pCode">     </pre>


<a name="wp28302"></a><pre class="pCode">       //===============================================================</pre>


<a name="wp28303"></a><pre class="pCode">       // Cache Read Miss Callback</pre>


<a name="wp28304"></a><pre class="pCode">       //===============================================================</pre>


<a name="wp28305"></a><pre class="pCode">       virtual void read_miss(uint64_t address)</pre>


<a name="wp28306"></a><pre class="pCode">       {    </pre>


<a name="wp28307"></a><pre class="pCode">         std::cout &lt;&lt; sc_core::sc_time_stamp() &lt;&lt; &quot;: &quot; &lt;&lt; instance_name  </pre>


<a name="wp28308"></a><pre class="pCode">                   &lt;&lt; &quot; read miss callback was called: &quot;</pre>


<a name="wp28309"></a><pre class="pCode">                   &lt;&lt; &quot; address= 0x&quot; &lt;&lt; hex &lt;&lt; address &lt;&lt; endl;</pre>


<a name="wp28310"></a><pre class="pCode">       }</pre>


<a name="wp28311"></a><pre class="pCode">     };</pre>


<a name="wp28312"></a><pre class="pCode">     </pre>


<a name="wp28313"></a><pre class="pCode">     //Define the core trace class and overload the required callbacks</pre>


<a name="wp28314"></a><pre class="pCode">     class my_core_trace : public mb::qemu::core_b::trace {</pre>


<a name="wp28315"></a><pre class="pCode">     </pre>


<a name="wp28316"></a><pre class="pCode">      public:</pre>


<a name="wp28317"></a><pre class="pCode">       my_core_trace() {}</pre>


<a name="wp28318"></a><pre class="pCode">     </pre>


<a name="wp28319"></a><pre class="pCode">       /** Called when an IRQ signal is changed. */</pre>


<a name="wp28320"></a><pre class="pCode">       virtual void set_irq_level(int irq, bool level) {</pre>


<a name="wp28321"></a><pre class="pCode">         std::cout &lt;&lt; sc_core::sc_time_stamp() &lt;&lt; </pre>


<a name="wp28322"></a><pre class="pCode">           &quot;: Core Trace &quot; &lt;&lt;</pre>


<a name="wp28323"></a><pre class="pCode">           &quot;set_irq_level &quot; &lt;&lt; irq &lt;&lt; &quot; : &quot; &lt;&lt; level &lt;&lt; &quot;\n&quot;;</pre>


<a name="wp28324"></a><pre class="pCode">       }</pre>


<a name="wp28325"></a><pre class="pCode">     </pre>


<a name="wp28326"></a><pre class="pCode">       /** Called when a SLEEP mode is initiated. */</pre>


<a name="wp28327"></a><pre class="pCode">       virtual void wait_for_interrupt_begin() { </pre>


<a name="wp28328"></a><pre class="pCode">         std::cout &lt;&lt; sc_core::sc_time_stamp() &lt;&lt; </pre>


<a name="wp28329"></a><pre class="pCode">           &quot;: Core Trace &quot; &lt;&lt;</pre>


<a name="wp28330"></a><pre class="pCode">           &quot;wait_for_interrupt_begin \n&quot;;</pre>


<a name="wp28331"></a><pre class="pCode">      }</pre>


<a name="wp28332"></a><pre class="pCode">         </pre>


<a name="wp28333"></a><pre class="pCode">       /** Called when a SLEEP mode is finished. */</pre>


<a name="wp28334"></a><pre class="pCode">       virtual void wait_for_interrupt_end() {</pre>


<a name="wp28335"></a><pre class="pCode">         std::cout &lt;&lt; sc_core::sc_time_stamp() &lt;&lt; </pre>


<a name="wp28336"></a><pre class="pCode">           &quot;: Core Trace &quot; &lt;&lt;</pre>


<a name="wp28337"></a><pre class="pCode">           &quot;wait_for_interrupt_end \n&quot;;</pre>


<a name="wp28338"></a><pre class="pCode">       }</pre>


<a name="wp28339"></a><pre class="pCode">     };</pre>


<a name="wp28340"></a><pre class="pCode">     </pre>


<a name="wp28341"></a><pre class="pCode">     </pre>


<a name="wp28342"></a><pre class="pCode">     int sc_main (int argc, char * argv []) {</pre>


<a name="wp28343"></a><pre class="pCode">     </pre>


<a name="wp28344"></a><pre class="pCode">       sc_report_handler::set_actions(&quot;/IEEE_Std_1666/deprecated&quot;, SC_DO_NOTHING);</pre>


<a name="wp28345"></a><pre class="pCode">       </pre>


<a name="wp28346"></a><pre class="pCode">       top_arm * top1 = new top_arm (&quot;Top&quot; );</pre>


<a name="wp28347"></a><pre class="pCode">       mb::models::cache&lt;32&gt;* dcache_ptr;</pre>


<a name="wp28348"></a><pre class="pCode">     </pre>


<a name="wp28349"></a><pre class="pCode">       my_core_trace core_trace;</pre>


<a name="wp28350"></a><pre class="pCode">       my_cache_trace dcache_trace(&quot;DCache Trace&quot;);</pre>


<a name="wp28351"></a><pre class="pCode">     </pre>


<a name="wp28352"></a><pre class="pCode">       //Enable the Core Trace</pre>


<a name="wp28353"></a><pre class="pCode">       top1-&gt;cpu_inst-&gt;getPV()-&gt;get_core().add_trace(&amp;core_trace);</pre>


<a name="wp28354"></a><pre class="pCode">       dcache_ptr = top1-&gt;cpu_inst-&gt;getPV()-&gt;get_dcache();</pre>


<a name="wp28355"></a><pre class="pCode">     </pre>


<a name="wp28356"></a><pre class="pCode">       if (!dcache_ptr)</pre>


<a name="wp28357"></a><pre class="pCode">       {</pre>


<a name="wp28358"></a><pre class="pCode">         cout &lt;&lt;&quot;:Warning - no Dcache in this core&quot; &lt;&lt; endl;</pre>


<a name="wp28359"></a><pre class="pCode">       }</pre>


<a name="wp28360"></a><pre class="pCode">       else</pre>


<a name="wp28361"></a><pre class="pCode">       {</pre>


<a name="wp28362"></a><pre class="pCode">         //Define the cachable region</pre>


<a name="wp28363"></a><pre class="pCode">         top1-&gt;cpu_inst-&gt;getPV()-&gt;enable_cache(0, 0x10000000-1);</pre>


<a name="wp28364"></a><pre class="pCode">         //Enable the Cache Trace</pre>


<a name="wp28365"></a><pre class="pCode">         dcache_ptr-&gt;add_trace(&amp;dcache_trace);</pre>


<a name="wp28366"></a><pre class="pCode">       }</pre>


<a name="wp28367"></a><pre class="pCode">     </pre>


<a name="wp28368"></a><pre class="pCode">       sc_start ();</pre>


<a name="wp28369"></a><pre class="pCode">     </pre>


<a name="wp28370"></a><pre class="pCode">       delete top1;</pre>


<a name="wp28371"></a><pre class="pCode">       return 0;</pre>


<a name="wp28372"></a><pre class="pCode">     }</pre>


<a name="wp28374"></a><p class="pBody">
After the example is built and run, the following output is displayed. Note the highlighted sections which represents the output of the trace API functions callbacks:
</p>


<a name="wp28375"></a><pre class="pCode">     Top.cpu_inst.PV: enabling cache region: 0 : fffffff</pre>


<a name="wp28376"></a><pre class="pCode">     Top.cpu_inst.PV.core: Loading ELF: sw/sw_arm.x</pre>


<a name="wp28377"></a><pre class="pCode">     110 ns: DCache Trace read miss callback was called:  address= 0xe0</pre>


<a name="wp28378"></a><pre class="pCode">     820 ns: DCache Trace write miss callback was called :  address= 0x86c</pre>


<a name="wp28379"></a><pre class="pCode">     830 ns: DCache Trace write_hit line= 10c address= 0x870</pre>


<a name="wp28380"></a><pre class="pCode">     840 ns: DCache Trace write_hit line= 10c address= 0x874</pre>


<a name="wp28381"></a><pre class="pCode">     </pre>


<a name="wp28382"></a><pre class="pCode">     990 ns: DCache Trace read miss callback was called:  address= 0x3d4</pre>


<a name="wp28383"></a><pre class="pCode">     1070 ns: DCache Trace write miss callback was called :  address= 0xaa0</pre>


<a name="wp28384"></a><pre class="pCode">     1150 ns: DCache Trace write_hit line= 10c address= 0x860</pre>


<a name="wp28385"></a><pre class="pCode">     1170 ns: DCache Trace write_hit line= 108 address= 0x854</pre>


<a name="wp28386"></a><pre class="pCode">     </pre>


<a name="wp28387"></a><pre class="pCode">     Top.dma_inst.PV @ 18430 ns (922) Trigger Callback</pre>


<a name="wp28388"></a><pre class="pCode">     Top.dma_inst.PV Source=0x1000000 Destination=0x1000100 Size=16</pre>


<a name="wp28389"></a><pre class="pCode">     Top.dma_inst.PV @ 18430 ns (922) master_read</pre>


<a name="wp28390"></a><pre class="pCode">     Top.dma_inst.PV {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0}</pre>


<a name="wp28391"></a><pre class="pCode">     Top.dma_inst.PV @ 18430 ns (922) master_write</pre>


<a name="wp28392"></a><pre class="pCode">     Top.dma_inst.PV @ 18430 ns (922) Assert Interrupt</pre>


<a name="wp28393"></a><pre class="pCode">     19400 ns: Core Trace set_irq_level 2 : 0</pre>


<a name="wp28394"></a><pre class="pCode">     19490 ns: DCache Trace write miss callback was called :  address= 0x970</pre>


<a name="wp28395"></a><pre class="pCode">     19560 ns: DCache Trace write_hit line= 12c address= 0x974</pre>


<a name="wp28396"></a><pre class="pCode">     19570 ns: DCache Trace write_hit line= 12c address= 0x978</pre>


<a name="wp28397"></a><pre class="pCode">     </pre>


<a name="wp28398"></a><pre class="pCode">     Top.dma_inst.PV @ 19950 ns (1070) Deassert Interrupt</pre>


<a name="wp28399"></a><pre class="pCode">     20 us: Core Trace set_irq_level 2 : 1</pre>


<a name="wp28400"></a><pre class="pCode">     20010 ns: DCache Trace write_hit line= 336 address= 0xa9c</pre>


<a name="wp28401"></a><pre class="pCode">     20320 ns: DCache Trace write_hit line= 154 address= 0xaa0</pre>


<a name="wp28402"></a><pre class="pCode">     </pre>


<a name="wp28403"></a><pre class="pCode">     Execution stopped by software write4(0x50000100) 0x2 at 25440 ns</pre>


<a name="wp28404"></a><pre class="pCode">     25450 ns: DCache Trace write_hit line= 264 address= 0x0x85c</pre>


<a name="wp28405"></a><pre class="pCode">     CPU Top.cpu_inst.PV.core has finished at 25460 ns (0x54c cycles).</pre>


<a name="wp28406"></a><pre class="pCode">        Executed instructions (millions): 0.00</pre>


<a name="wp28407"></a><pre class="pCode">        Simulated MIPS: 59.66</pre>




<script type="text/javascript" language="JavaScript1.2">
<!--
   PageTitle = "Trace API Example ";
   PDFLinkTitle = "Trace.API.Example."
   ThisTopic = "FIGURETraceAPIExampleSystem";
   CurrentFile = "Chapter_Customizing_Gen_Models_new57.html";
   MGCSetDocumentVariables();
   MGCUpdateNavPane();
      MGCInsertRTFooter();
 // -->
 </script>



  </body>
</html>
