
/**************************************************************/
/*                                                            */
/*      Copyright Mentor Graphics Corporation 2006 - 2012     */
/*                  All Rights Reserved                       */
/*                                                            */
/*       THIS WORK CONTAINS TRADE SECRET AND PROPRIETARY      */
/*         INFORMATION WHICH IS THE PROPERTY OF MENTOR        */
/*         GRAPHICS CORPORATION OR ITS LICENSORS AND IS       */
/*                 SUBJECT TO LICENSE TERMS.                  */
/*                                                            */
/**************************************************************/

//*<
//* Generated By Model Builder, Mentor Graphics Computer Systems, Inc.
//*
//* This file contains the PV class for extIn.
//* This is a template file: You may modify this file to implement the 
//* behavior of your component. 
//* 
//* Model Builder version: 3.5.0
//* Generated on: Jan. 08, 2013 08:17:04 AM, (user: jon)
//*>


#include "extIn_pv.h"

//constructor
extIn_pv::extIn_pv(sc_module_name module_name)
  : extIn_pv_base(module_name)
{
  SC_THREAD(thread);
}

extIn_pv::~extIn_pv() {
}

void extIn_pv::thread() {
  if (strcmp(DriverFunction, "off") == 0);
    //do nothing
  else if (strcmp(DriverFunction, "simple") == 0)
    simple();
  else if (strcmp(DriverFunction, "random") == 0)
    random();
  else {
    std::cout << this->name() << " thread(): Parameter DriverFunction = " << DriverFunction;
    std::cout << ". This value is not defined, it will be ignored." << endl;
  }
}

void extIn_pv::simple() {
  mb_distribution *waitdist = mb_CreateDistribution(WaitDist);
  unsigned int d[10] = {1, 2, 3, 4, 5, 6, 7, 8, 9, 10};
  unsigned int i, j;

  wait(1, SC_SEC);
  wait(waitdist->getNextInt() * clock);

  for (i = 0; i<NumberPackets; i++) {
    y_write(0x40000000, i);
    cout << "        Wrote " << dec << i << endl;
    wait(waitdist->getNextInt() * clock);
  }

  wait(1000*clock);
  sleep(5);
  sc_stop();
}

void extIn_pv::random() {
  mb_distribution *sizedist = mb_CreateDistribution(SizeDist);
  mb_distribution *addrdist = mb_CreateDistribution(AddrDist);
  mb_distribution *waitdist = mb_CreateDistribution(WaitDist);
  unsigned int d[MaxPacketSize];
  unsigned int dcheck[MaxPacketSize];
  unsigned int s, a;

  srand(5647);

  for (unsigned i = 0; i < NumberPackets; i++) {
    a = addrdist->getNextInt();
    s = sizedist->getNextInt();
    s = s % MaxPacketSize;

    for (unsigned j = 0; j < s; j++) d[j] = rand();
    memcpy(dcheck, d, s*4);

    y_write(a, d, s);
    wait(clock);
    y_read(a, dcheck, s);

    for (unsigned j = 0; j < s; j++) {
      assert (d[j] == dcheck[j]);
    }

    wait(waitdist->getNextInt() * clock);
  }
}
